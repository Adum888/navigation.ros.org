

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a New Costmap2D Plugin &mdash; Navigation 2 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon-48x48.png"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Writing a New Planner Plugin" href="writing_new_nav2planner_plugin.html" />
    <link rel="prev" title="(STVL) Using an External Costmap Plugin" href="navigation2_with_stvl.html" />

<link rel="stylesheet" href="../../_static/tcs_theme.css" type="text/css" />


</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Navigation 2
          

          
            
            <img src="../../_static/logo_white_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started/index.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started/index.html#running-the-example">Running the Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started/index.html#navigating">Navigating</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../build_instructions/index.html">Build and Install</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../build_instructions/index.html#install">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build_instructions/index.html#build">Build</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/index.html#build-navigation2-for-released-distribution">Build Navigation2 For Released Distribution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#install-ros">Install ROS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#build-navigation2">Build Navigation2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/index.html#quickstart-build-master">Quickstart Build Master</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#steps">Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#options">Options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/index.html#manually-build-master">Manually Build Master</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#build-ros-2-master">Build ROS 2 Master</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#build-navigation2-dependencies">Build Navigation2 Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/index.html#build-navigation2-master">Build Navigation2 Master</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../build_instructions/index.html#docker">Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/index.html#building-docker-container">Building Docker Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/index.html#using-dockerhub-container">Using DockerHub Container</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../build_instructions/index.html#generate-doxygen">Generate Doxygen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build_instructions/index.html#help">Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../build_instructions/build_docs/build_troubleshooting_guide.html">Build Troubleshooting Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/build_docs/build_troubleshooting_guide.html#common-navigation2-dependencies-build-failures">Common Navigation2 Dependencies Build Failures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../build_instructions/build_docs/build_troubleshooting_guide.html#reporting-issue">Reporting Issue</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">Navigation Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html#ros2">ROS2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#action-server">Action Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#lifecycle-nodes">Lifecycle Nodes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html#behavior-trees">Behavior Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html#navigation-servers">Navigation Servers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#planner-controller-and-recovery-servers">Planner, Controller, and Recovery Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#planners">Planners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#controllers">Controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#recoveries">Recoveries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html#state-estimation">State Estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#standards">Standards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#global-positioning-localization-and-slam">Global Positioning: Localization and SLAM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#odometry">Odometry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html#environmental-representation">Environmental Representation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#costmaps-and-layers">Costmaps and Layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../concepts/index.html#other-forms">Other Forms</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="navigation2_on_real_turtlebot3.html">Navigating with a Physical Turtlebot 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#tutorial-steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#setup-your-enviroment-variables">0- Setup Your Enviroment Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#launch-turtlebot-3">1- Launch Turtlebot 3</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#launch-navigation2">2- Launch Navigation2</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#launch-rviz">3-  Launch RVIZ</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#initialize-the-location-of-turtlebot-3">4- Initialize the Location of Turtlebot 3</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_on_real_turtlebot3.html#send-a-goal-pose">5-  Send a Goal Pose</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="navigation2_with_slam.html">(SLAM) Navigating While Mapping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_slam.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_slam.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_slam.html#tutorial-steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_slam.html#launch-robot-interfaces">0- Launch Robot Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_slam.html#launch-navigation2">1- Launch Navigation2</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_slam.html#launch-slam">2- Launch SLAM</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_slam.html#working-with-slam">3- Working with SLAM</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="navigation2_with_stvl.html">(STVL) Using an External Costmap Plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_stvl.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_stvl.html#costmap2d-and-stvl">Costmap2D and STVL</a></li>
<li class="toctree-l3"><a class="reference internal" href="navigation2_with_stvl.html#tutorial-steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_stvl.html#setup">0- Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_stvl.html#install-stvl">1- Install STVL</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_stvl.html#modify-navigation2-parameter">1- Modify Navigation2 Parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_stvl.html#launch-navigation2">2- Launch Navigation2</a></li>
<li class="toctree-l4"><a class="reference internal" href="navigation2_with_stvl.html#rviz">3-  RVIZ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing a New Costmap2D Plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tutorial-steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#write-a-new-costmap2d-plugin">1- Write a new Costmap2D plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#export-and-make-gradientlayer-plugin">2- Export and make GradientLayer plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-the-plugin-in-costmap2d">3- Enable the plugin in Costmap2D</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-gradientlayer-plugin">4- Run GradientLayer plugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writing_new_nav2planner_plugin.html">Writing a New Planner Plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="writing_new_nav2planner_plugin.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing_new_nav2planner_plugin.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing_new_nav2planner_plugin.html#tutorial-steps">Tutorial Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writing_new_nav2planner_plugin.html#creating-a-new-planner-plugin">1- Creating a new Planner Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="writing_new_nav2planner_plugin.html#exporting-the-planner-plugin">2- Exporting the planner plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="writing_new_nav2planner_plugin.html#pass-the-plugin-name-through-params-file">3- Pass the plugin name through params file</a></li>
<li class="toctree-l4"><a class="reference internal" href="writing_new_nav2planner_plugin.html#run-straightline-plugin">4- Run StraightLine plugin</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration Guidelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/configuring-the-controller.html">Configuring The Controller</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/configuring-the-controller.html#controller-server">Controller Server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/configuring-the-controller.html#parameters">Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/configuring-the-controller.html#progress-checker">Progress Checker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/configuring-the-controller.html#id2">Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/configuring-the-controller.html#dwb-controller">DWB Controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/configuring-the-controller.html#id3">Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/configuring-the-controller.html#additional-parameters">Additional Parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/configuring-the-controller.html#debug-parameters">Debug Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/configuring-the-controller.html#dwb-plugins">DWB Plugins</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/dwb-plugins/trajectory-generators.html">Trajectory Generators</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/dwb-plugins/trajectory-critics.html">Trajectory Critics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../configuration/dwb-plugins/goal-checkers.html">Goal Checkers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/params/tunable-params.html">Tunable Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#amcl">AMCL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#controller-server">Controller Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#local-costmap">Local Costmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#planner-server">Planner Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#global-costmap">Global Costmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#map-server">Map Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#recovery-server">Recovery Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/params/tunable-params.html#bt-navigator">BT Navigator</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Navigation Plugins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.html#costmap-layers">Costmap Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.html#controllers">Controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.html#planners">Planners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.html#recoveries">Recoveries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.html#behavior-tree-nodes">Behavior Tree Nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../migration/index.html">Migration Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../migration/Dashing.html">Dashing to Eloquent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Dashing.html#new-packages">New Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Dashing.html#new-plugins">New Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Dashing.html#navigation2-architectural-changes">Navigation2 Architectural Changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../migration/Eloquent.html">Eloquent to Foxy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Eloquent.html#general">General</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Eloquent.html#server-updates">Server Updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Eloquent.html#new-plugins">New Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../migration/Eloquent.html#map-server-re-work">Map Server Re-Work</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Getting Involved</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/index.html#id1">Getting Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/index.html#process">Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute/index.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About and Contact</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/robots.html">Robots Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/ros1_comparison.html">ROS to ROS2 Navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#id1">About</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#contact">Contact</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Navigation 2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Tutorials</a> &raquo;</li>
        
      <li>Writing a New Costmap2D Plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-new-costmap2d-plugin">
<span id="writing-new-costmap2d-plugin"></span><h1>Writing a New Costmap2D Plugin<a class="headerlink" href="#writing-a-new-costmap2d-plugin" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#tutorial-steps">Tutorial Steps</a></li>
</ul>
<a class="reference internal image-reference" href="../../_images/gradient_layer_preview.gif"><img alt="Animated gif with gradient demo" class="align-center" src="../../_images/gradient_layer_preview.gif" style="width: 700px;" /></a>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This tutorial shows how to create your own simple <a class="reference external" href="http://wiki.ros.org/pluginlib">plugin</a> for Costmap2D.</p>
<p>Before starting the tutorial, please check this <a class="reference external" href="https://vimeo.com/106994708">video</a> which contains information about Costmap2D layers design and plugins basic operational principals.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>It is assumed that ROS2, Gazebo and TurtleBot3 packages are installed or built locally. Please make sure that Navigation2 project is also built locally as it was made in <a class="reference internal" href="../../build_instructions/index.html#build-instructions"><span class="std std-ref">Build and Install</span></a>.</p>
</div>
<div class="section" id="tutorial-steps">
<h2>Tutorial Steps<a class="headerlink" href="#tutorial-steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="write-a-new-costmap2d-plugin">
<h3>1- Write a new Costmap2D plugin<a class="headerlink" href="#write-a-new-costmap2d-plugin" title="Permalink to this headline">¶</a></h3>
<p>For a demonstration, this example will creates a costmap plugin that puts repeating costs gradients in the costmap.
The annotated code for this tutorial can be found in <a class="reference external" href="https://github.com/ros-planning/navigation2_tutorials">navigation2_tutorials</a> repository as the <code class="docutils literal notranslate"><span class="pre">nav2_gradient_costmap_plugin</span></code> ROS2-package.
Please refer to it when making your own layer plugin for Costmap2D.</p>
<p>The plugin class <code class="docutils literal notranslate"><span class="pre">nav2_gradient_costmap_plugin::GradientLayer</span></code> is inherited from basic class <code class="docutils literal notranslate"><span class="pre">nav2_costmap_2d::Layer</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="n">nav2_gradient_costmap_plugin</span>
<span class="p">{</span>

<span class="n">class</span> <span class="nl">GradientLayer</span> <span class="p">:</span> <span class="n">public</span> <span class="n">nav2_costmap_2d</span><span class="o">::</span><span class="n">Layer</span>
</pre></div>
</div>
<p>The basic class provides the set of virtual methods API for working with costmap layers in a plugin. These methods are calling in runtime by <code class="docutils literal notranslate"><span class="pre">LayeredCostmap</span></code>. The list of methods, their description and necessity to have these methods in plugin’s code is presented in the table below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="62%" />
<col width="20%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Virtual method</strong></td>
<td><strong>Method description</strong></td>
<td><strong>Requires override?</strong></td>
</tr>
<tr class="row-even"><td>onInitialize()</td>
<td>Method is called at the end of plugin initialization. There is usually
declarations of ROS parameters. This is where any required initialization
should occur.</td>
<td>No</td>
</tr>
<tr class="row-odd"><td>updateBounds()</td>
<td>Method is called to ask the plugin: which area of costmap layer it needs
to update. There are 3 input parameters of method: robot position and
orientation and 4 output parameters: pointers to window bounds.
These bounds are used for performance reasons: to update the area
inside the window where is new info available, avoiding updates of whole
costmap on every iteration.</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>updateCosts()</td>
<td>Method is called each time when costmap re-calculation is required. It
updates the costmap layer only within its bounds window. There are 4 input
parameters of method: calculation window bounds and 1 output parameter:
reference to a resulting costmap <code class="docutils literal notranslate"><span class="pre">master_grid</span></code>. The <code class="docutils literal notranslate"><span class="pre">Layer</span></code> class
provides the plugin with an internal costmap, <code class="docutils literal notranslate"><span class="pre">costmap_</span></code>, for updates.
The <code class="docutils literal notranslate"><span class="pre">master_grid</span></code> should be updated with values within the window bounds
using one of the following update methods: <code class="docutils literal notranslate"><span class="pre">updateWithAddition()</span></code>,
<code class="docutils literal notranslate"><span class="pre">updateWithMax()</span></code>, <code class="docutils literal notranslate"><span class="pre">updateWithOverwrite()</span></code> or
<code class="docutils literal notranslate"><span class="pre">updateWithTrueOverwrite()</span></code>.</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>matchSize()</td>
<td>Method is called each time when map size was changed.</td>
<td>No</td>
</tr>
<tr class="row-even"><td>onFootprintChanged()</td>
<td>Method is called each time when footprint was changed.</td>
<td>No</td>
</tr>
<tr class="row-odd"><td>reset()</td>
<td>It may have any code to be executed during costmap reset.</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>In our example these methods have the following functionality:</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">GradientLayer::onInitialize()</span></code> contains declaration of ROS parameter with its default value:</li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">declareParameter</span><span class="p">(</span><span class="s">&quot;enabled&quot;</span><span class="p">,</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterValue</span><span class="p">(</span><span class="nb">true</span><span class="p">));</span>
<span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">name_</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="s">&quot;enabled&quot;</span><span class="p">,</span> <span class="n">enabled_</span><span class="p">);</span>
</pre></div>
</div>
<p>and sets <code class="docutils literal notranslate"><span class="pre">need_recalculation_</span></code> bounds recalculation indicator:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">need_recalculation_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><code class="docutils literal notranslate"><span class="pre">GradientLayer::updateBounds()</span></code> re-calculates window bounds if <code class="docutils literal notranslate"><span class="pre">need_recalculation_</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> and updates them regardless of <code class="docutils literal notranslate"><span class="pre">need_recalculation_</span></code> value.</li>
<li><code class="docutils literal notranslate"><span class="pre">GradientLayer::updateCosts()</span></code> - in this method the gradient is writing directly to the resulting costmap <code class="docutils literal notranslate"><span class="pre">master_grid</span></code> without merging with previous layers. This is equal to working with internal <code class="docutils literal notranslate"><span class="pre">costmap_</span></code> and then calling <code class="docutils literal notranslate"><span class="pre">updateWithTrueOverwrite()</span></code> method. Here is the gradient making algorithm for master costmap:</li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">gradient_index</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">min_j</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_j</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Reset gradient_index each time when reaching the end of re-calculated window</span>
  <span class="c1">// by OY axis.</span>
  <span class="n">gradient_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">min_i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">master_grid</span><span class="p">.</span><span class="n">getIndex</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
    <span class="c1">// setting the gradient cost</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">LETHAL_OBSTACLE</span> <span class="o">-</span> <span class="n">gradient_index</span><span class="o">*</span><span class="n">GRADIENT_FACTOR</span><span class="p">)</span><span class="o">%</span><span class="mi">255</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gradient_index</span> <span class="o">&lt;=</span> <span class="n">GRADIENT_SIZE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">gradient_index</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">gradient_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">master_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where the <code class="docutils literal notranslate"><span class="pre">GRADIENT_SIZE</span></code> is the size of each gradient period in map cells, <code class="docutils literal notranslate"><span class="pre">GRADIENT_FACTOR</span></code> - decrement of costmap’s value per each step:</p>
<img alt="../../_images/gradient_explanation.png" src="../../_images/gradient_explanation.png" />
<p>These parameters are defined in plugin’s header file.</p>
<ol class="arabic simple" start="4">
<li><code class="docutils literal notranslate"><span class="pre">GradientLayer::onFootprintChanged()</span></code> just resets <code class="docutils literal notranslate"><span class="pre">need_recalculation_</span></code> value.</li>
<li><code class="docutils literal notranslate"><span class="pre">GradientLayer::reset()</span></code> method is dummy: it is not used in this example plugin. It remaining there since pure virtual function <code class="docutils literal notranslate"><span class="pre">reset()</span></code> in parent <code class="docutils literal notranslate"><span class="pre">Layer</span></code> class required to be overriden.</li>
</ol>
</div>
<div class="section" id="export-and-make-gradientlayer-plugin">
<h3>2- Export and make GradientLayer plugin<a class="headerlink" href="#export-and-make-gradientlayer-plugin" title="Permalink to this headline">¶</a></h3>
<p>The written plugin will be loaded in runtime as it’s basic parent class and then will be called by plugin handling modules (for costmap2d by <code class="docutils literal notranslate"><span class="pre">LayeredCostmap</span></code>). Pluginlib opens a given plugin in run-time and provides methods from exported classes to be callable. The mechanism of class exporting tells pluginlib which basic class should be used during these calls. This allows to extend an application by plugins without knowing application source code or recompiling it.</p>
<p>In our example the <code class="docutils literal notranslate"><span class="pre">nav2_gradient_costmap_plugin::GradientLayer</span></code> plugin’s class should be dynamically loaded as a <code class="docutils literal notranslate"><span class="pre">nav2_costmap_2d::Layer</span></code> basic class. For this the plugin should be registered as follows:</p>
<ol class="arabic simple">
<li>Plugin’s class should be registered with a basic type of loaded class. For this there is a special macro <code class="docutils literal notranslate"><span class="pre">PLUGINLIB_EXPORT_CLASS</span></code> should be added to any source-file composing the plugin library:</li>
</ol>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>#include &quot;pluginlib/class_list_macros.hpp&quot;
PLUGINLIB_EXPORT_CLASS(nav2_gradient_costmap_plugin::GradientLayer, nav2_costmap_2d::Layer)
</pre></div>
</div>
<p>This part is usually placed at the end of cpp-file where the plugin class was written (in our example <code class="docutils literal notranslate"><span class="pre">gradient_layer.cpp</span></code>). It is good practice to place these lines at the end of the file but technically, you can also place at the top.</p>
<ol class="arabic simple" start="2">
<li>Plugin’s inormation should be stored to plugin description file. This is done by using separate XML (in our example <code class="docutils literal notranslate"><span class="pre">gradient_plugins.xml</span></code>) in the plugin’s package. This file contains information about:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">path</span></code>: Path and name of library where plugin is placed.</li>
<li><code class="docutils literal notranslate"><span class="pre">name</span></code>: Plugin type referenced in <code class="docutils literal notranslate"><span class="pre">plugin_types</span></code> parameter (see next section for more details). It could be whatever you want.</li>
<li><code class="docutils literal notranslate"><span class="pre">type</span></code>: Plugin class with namespace taken from the source code.</li>
<li><code class="docutils literal notranslate"><span class="pre">basic_class_type</span></code>: Basic parent class from which plugin class was derived.</li>
<li><code class="docutils literal notranslate"><span class="pre">description</span></code>: Plugin description in a text form.</li>
</ul>
</div></blockquote>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;library</span> <span class="na">path=</span><span class="s">&quot;nav2_gradient_costmap_plugin_core&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;class</span> <span class="na">name=</span><span class="s">&quot;nav2_gradient_costmap_plugin/GradientLayer&quot;</span> <span class="na">type=</span><span class="s">&quot;nav2_gradient_costmap_plugin::GradientLayer&quot;</span> <span class="na">base_class_type=</span><span class="s">&quot;nav2_costmap_2d::Layer&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description&gt;</span>This is an example plugin which puts repeating costs gradients to costmap<span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;/class&gt;</span>
<span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
<p>The export of plugin is performed by including <code class="docutils literal notranslate"><span class="pre">pluginlib_export_plugin_description_file()</span></code> cmake-function into <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. This function installs plugin description file into <code class="docutils literal notranslate"><span class="pre">share</span></code> directory and sets ament indexes for plugin description XML to be discoverable as a plugin of selected type:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>pluginlib_export_plugin_description_file(nav2_costmap_2d gradient_layer.xml)
</pre></div>
</div>
<p>Plugin description file is also should be added to <code class="docutils literal notranslate"><span class="pre">package.xml</span></code>. <code class="docutils literal notranslate"><span class="pre">costmap_2d</span></code> is the package of the interface definition, for our case <code class="docutils literal notranslate"><span class="pre">Layer</span></code>, and requires a path to the xml file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;export&gt;
  &lt;costmap_2d plugin=&quot;${prefix}/gradient_layer.xml&quot; /&gt;
  ...
&lt;/export&gt;
</pre></div>
</div>
<p>After everything is done put the plugin package into <code class="docutils literal notranslate"><span class="pre">src</span></code> directory of a certain ROS2-workspace, build the plugin package (<code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--packages-select</span> <span class="pre">nav2_gradient_costmap_plugin</span> <span class="pre">--symlink-install</span></code>) and source <code class="docutils literal notranslate"><span class="pre">setup.bash</span></code> file when it necessary.</p>
<p>Now the plugin is ready to use.</p>
</div>
<div class="section" id="enable-the-plugin-in-costmap2d">
<h3>3- Enable the plugin in Costmap2D<a class="headerlink" href="#enable-the-plugin-in-costmap2d" title="Permalink to this headline">¶</a></h3>
<p>At the next step it is required to tell Costmap2D about new plugin. For that the plugin should be added to <code class="docutils literal notranslate"><span class="pre">plugin_names</span></code> and <code class="docutils literal notranslate"><span class="pre">plugin_types</span></code> lists in <code class="docutils literal notranslate"><span class="pre">nav2_params.yaml</span></code> optionally for <code class="docutils literal notranslate"><span class="pre">local_costmap</span></code>/<code class="docutils literal notranslate"><span class="pre">global_costmap</span></code> in order to be enabled in run-time for Controller/Planner Server. <code class="docutils literal notranslate"><span class="pre">plugin_names</span></code> list contains the names of plugin objects. These names could be anything you want. <code class="docutils literal notranslate"><span class="pre">plugin_types</span></code> contains types of listed in <code class="docutils literal notranslate"><span class="pre">plugin_names</span></code> objects. These types should correspond to <code class="docutils literal notranslate"><span class="pre">name</span></code> field of plugin class specified in plugin description XML-file.</p>
<p>For example:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/nav2_bringup/bringup/params/nav2_params.yaml</span>
<span class="gi">+++ b/nav2_bringup/bringup/params/nav2_params.yaml</span>
<span class="gu">@@ -124,8 +124,8 @@ local_costmap:</span>
       width: 3
       height: 3
       resolution: 0.05
<span class="gd">-      plugin_names: [&quot;obstacle_layer&quot;, &quot;voxel_layer&quot;, &quot;inflation_layer&quot;]</span>
<span class="gd">-      plugin_types: [&quot;nav2_costmap_2d::ObstacleLayer&quot;, &quot;nav2_costmap_2d::VoxelLayer&quot;, &quot;nav2_costmap_2d::InflationLayer&quot;]</span>
<span class="gi">+      plugin_names: [&quot;obstacle_layer&quot;, &quot;voxel_layer&quot;, &quot;gradient_layer&quot;]</span>
<span class="gi">+      plugin_types: [&quot;nav2_costmap_2d::ObstacleLayer&quot;, &quot;nav2_costmap_2d::VoxelLayer&quot;, &quot;nav2_gradient_costmap_plugin/GradientLayer&quot;]</span>
       robot_radius: 0.22
       inflation_layer:
         cost_scaling_factor: 3.0
<span class="gu">@@ -171,8 +171,8 @@ global_costmap:</span>
       robot_base_frame: base_link
       global_frame: map
       use_sim_time: True
<span class="gd">-      plugin_names: [&quot;static_layer&quot;, &quot;obstacle_layer&quot;, &quot;voxel_layer&quot;, &quot;inflation_layer&quot;]</span>
<span class="gd">-      plugin_types: [&quot;nav2_costmap_2d::StaticLayer&quot;, &quot;nav2_costmap_2d::ObstacleLayer&quot;, &quot;nav2_costmap_2d::VoxelLayer&quot;, &quot;nav2_costmap_2d::InflationLayer&quot;]</span>
<span class="gi">+      plugin_names: [&quot;static_layer&quot;, &quot;obstacle_layer&quot;, &quot;voxel_layer&quot;, &quot;gradient_layer&quot;]</span>
<span class="gi">+      plugin_types: [&quot;nav2_costmap_2d::StaticLayer&quot;, &quot;nav2_costmap_2d::ObstacleLayer&quot;, &quot;nav2_costmap_2d::VoxelLayer&quot;, &quot;nav2_gradient_costmap_plugin/GradientLayer&quot;]</span>
       robot_radius: 0.22
       resolution: 0.05
       obstacle_layer:
</pre></div>
</div>
<p>YAML-file may also contain the list of parameters (if any) for each plugin, identified by plugins object name.</p>
<p>NOTE: there could be many simultaneously loaded plugin objects of one type. For this, <code class="docutils literal notranslate"><span class="pre">plugin_names</span></code> list should contain different plugins names whether the <code class="docutils literal notranslate"><span class="pre">plugin_types</span></code> will remain the same types. For example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>plugin_names: [&quot;obstacle_layer&quot;, &quot;gradient_layer_1&quot;, &quot;gradient_layer_2&quot;]
plugin_types: [&quot;nav2_costmap_2d::ObstacleLayer&quot;, &quot;nav2_gradient_costmap_plugin/GradientLayer&quot;, &quot;nav2_gradient_costmap_plugin/GradientLayer&quot;]
</pre></div>
</div>
<p>In this case each plugin object will be handled by its own parameters tree in a YAML-file, like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>gradient_layer_1:
  enabled: True
  ...
gradient_layer_2:
  enabled: False
  ...
</pre></div>
</div>
</div>
<div class="section" id="run-gradientlayer-plugin">
<h3>4- Run GradientLayer plugin<a class="headerlink" href="#run-gradientlayer-plugin" title="Permalink to this headline">¶</a></h3>
<p>Run Turtlebot3 simulation with enabled navigation2. Detailed instructuction how to make it are written at <a class="reference internal" href="../../getting_started/index.html#getting-started"><span class="std std-ref">Getting Started</span></a>. Below is shortcut command for that:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 launch nav2_bringup tb3_simulation_launch.py
</pre></div>
</div>
<p>Then goto RViz and click on the “2D Pose Estimate” button at the top and point the location on map as it was described in <a class="reference internal" href="../../getting_started/index.html#getting-started"><span class="std std-ref">Getting Started</span></a>. Robot will be localized on map and the result should be as presented at picture below. There is could be seen the gradient costmap. There are also 2 noticeable things: dynamically updated by <code class="docutils literal notranslate"><span class="pre">GradientLayer::updateCosts()</span></code> costmap within its bounds and global path curved by gradient:</p>
<a class="reference internal image-reference" href="../../_images/gradient_layer_run.png"><img alt="Image of gradient costmap used" class="align-center" src="../../_images/gradient_layer_run.png" style="width: 700px;" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  

<script type="text/javascript" src="../../_static/tcs_theme.js"></script>



</body>
</html>